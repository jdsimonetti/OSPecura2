<!-- Vue Nutrition -->
        <div id="view-feeding" class="hidden">
            <div class="card">
                <h2 style="color: #059669; margin-bottom: 8px; font-size: 18px; font-weight: 700;">🌾 Suivi Nutrition</h2>
                <p style="color: #64748b; font-size: 13px; margin-bottom: 16px;">Rations distribuées quotidiennement</p>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="openFeedingModal()">✚ Nouvelle saisie</button>
                    <button class="btn btn-success" onclick="importFeeding()">⬇ Import données</button>
                </div>
            </div>
            
            <div id="feeding-container"></div>
            
            <div id="empty-feeding" class="empty-state">
                <div class="empty-icon">🌾</div>
                <h3 class="empty-title">Aucune donnée nutrition</h3>
                <p class="empty-text">Ajoutez des enregistrements d'alimentation</p>
                <button class="btn btn-primary" onclick="openFeedingModal()">✚ Première saisie</button>
            </div>
        </div>
        
        <!-- Vue Statistiques -->
        <div id="view-stats" class="hidden">
            <div class="card">
                <h2 style="color: #2563eb; margin-bottom: 8px; font-size: 18px; font-weight: 700;">📈 Statistiques</h2>
                <p style="color: #64748b; font-size: 13px;">Vue d'ensemble de votre cheptel</p>
            </div>
            
            <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px;">
                <div class="stats-card">
                    <div class="stats-number text-blue" id="stat-total">0</div>
                    <div class="stats-label">Total</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number text-green" id="stat-present">0</div>
                    <div class="stats-label">Présents</div>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stats-card">
                    <div class="stats-number text-red" id="stat-exited">0</div>
                    <div class="stats-label">Sortis</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number text-blue" id="stat-males">0</div>
                    <div class="stats-label">Mâles</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number text-purple" id="stat-females">0</div>
                    <div class="stats-label">Femelles</div>
                </div>
            </div>
            
            <div class="card">
                <h3 style="font-weight: 700; margin-bottom: 12px; color: #1e293b; font-size: 16px;">Répartition par lot</h3>
                <div id="lots-breakdown"></div>
            </div>
            
            <div class="card">
                <h3 style="font-weight: 700; margin-bottom: 12px; color: #1e293b; font-size: 16px;">Causes de sortie</h3>
                <div id="exit-reasons"></div>
            </div>
        </div>
    </div>
    
    <button class="fab" onclick="fabAction()">✚</button>
</div>

<!-- Install Banner -->
<div id="installBanner" class="install-banner">
    <div class="install-text">Installer l'application sur votre appareil</div>
    <button class="install-btn" onclick="installApp()">Installer</button>
    <button onclick="dismissInstall()" style="background: transparent; border: none; color: white; padding: 8px; cursor: pointer;">✕</button>
</div>

<!-- Modals -->
<div id="addModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Ajouter animal</h2>
            <button class="close-btn" onclick="closeAddModal()">✕</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">ID animal *</label>
                <input type="text" class="form-input" placeholder="Ex: 001, A123..." id="inputId">
            </div>
            
            <div class="form-group">
                <label class="form-label">Date d'entrée</label>
                <input type="date" class="form-input" id="inputDate">
            </div>
            
            <div class="form-group">
                <label class="form-label">Date de naissance</label>
                <input type="date" class="form-input" id="inputBirthDate">
            </div>
            
            <div class="form-group">
                <label class="form-label">Nom éleveur</label>
                <input type="text" class="form-input" placeholder="Ex: Jacques SANTINI" id="inputBreeder">
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Sexe</label>
                    <select class="form-select" id="inputSex">
                        <option value="">Sélectionner</option>
                        <option value="Mâle">Mâle</option>
                        <option value="Femelle">Femelle</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Lot *</label>
                    <select class="form-select" id="inputLot">
                        <option value="">Sélectionner</option>
                        <option value="Béliers moins 1 an">Béliers moins 1 an</option>
                        <option value="Béliers plus 1 an">Béliers plus 1 an</option>
                        <option value="Agnelles de pensions">Agnelles de pensions</option>
                        <option value="Béliers adultes de pension">Béliers adultes de pension</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Emplacement *</label>
                <select class="form-select" id="inputLocation">
                    <option value="">Sélectionner</option>
                    <option value="Bergerie 1">Bergerie 1</option>
                    <option value="Bergerie 2">Bergerie 2</option>
                    <option value="Tunnel 1">Tunnel 1</option>
                    <option value="Tunnel 2">Tunnel 2</option>
                    <option value="Dactyle 1">Dactyle 1</option>
                    <option value="Dactyle 2">Dactyle 2</option>
                </select>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="addAnimal()">Ajouter</button>
                <button class="btn btn-secondary" onclick="closeAddModal()">Annuler</button>
            </div>
        </div>
    </div>
</div>

<div id="editModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Éditer animal</h2>
            <button class="close-btn" onclick="closeEditModal()">✕</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">ID animal</label>
                <input type="text" class="form-input" id="editId" disabled>
            </div>
            
            <div class="form-group">
                <label class="form-label">Date d'entrée</label>
                <input type="date" class="form-input" id="editDate">
            </div>
            
            <div class="form-group">
                <label class="form-label">Date de naissance</label>
                <input type="date" class="form-input" id="editBirthDate">
            </div>
            
            <div class="form-group">
                <label class="form-label">Nom éleveur</label>
                <input type="text" class="form-input" id="editBreeder">
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Sexe</label>
                    <select class="form-select" id="editSex">
                        <option value="">Sélectionner</option>
                        <option value="Mâle">Mâle</option>
                        <option value="Femelle">Femelle</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Lot *</label>
                    <select class="form-select" id="editLot">
                        <option value="">Sélectionner</option>
                        <option value="Béliers moins 1 an">Béliers moins 1 an</option>
                        <option value="Béliers plus 1 an">Béliers plus 1 an</option>
                        <option value="Agnelles de pensions">Agnelles de pensions</option>
                        <option value="Béliers adultes de pension">Béliers adultes de pension</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Emplacement *</label>
                <select class="form-select" id="editLocation">
                    <option value="">Sélectionner</option>
                    <option value="Bergerie 1">Bergerie 1</option>
                    <option value="Bergerie 2">Bergerie 2</option>
                    <option value="Tunnel 1">Tunnel 1</option>
                    <option value="Tunnel 2">Tunnel 2</option>
                    <option value="Dactyle 1">Dactyle 1</option>
                    <option value="Dactyle 2">Dactyle 2</option>
                </select>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveEditAnimal()">Sauver</button>
                <button class="btn btn-secondary" onclick="closeEditModal()">Annuler</button>
            </div>
        </div>
    </div>
</div>

<div id="exitModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Sortie animal</h2>
            <button class="close-btn" onclick="closeExitModal()">✕</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Animal à sortir *</label>
                <select class="form-select" id="exitAnimalSelect">
                    <option value="">Sélectionner</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Date sortie *</label>
                <input type="date" class="form-input" id="exitDate">
            </div>
            
            <div class="form-group">
                <label class="form-label">Cause sortie *</label>
                <select class="form-select" id="exitReason">
                    <option value="">Sélectionner</option>
                    <option value="MORT">MORT</option>
                    <option value="REFORME">RÉFORME</option>
                    <option value="VENTE">VENTE</option>
                    <option value="TRANSFERT">TRANSFERT</option>
                </select>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-danger" onclick="processExit()">Enregistrer</button>
                <button class="btn btn-secondary" onclick="closeExitModal()">Annuler</button>
            </div>
        </div>
    </div>
</div>

<div id="feedingModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Saisie nutrition</h2>
            <button class="close-btn" onclick="closeFeedingModal()">✕</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Date *</label>
                <input type="date" class="form-input" id="feedingDate">
            </div>
            
            <div class="form-group">
                <label class="form-label">Emplacement *</label>
                <select class="form-select" id="feedingLocation">
                    <option value="">Sélectionner</option>
                    <option value="Bergerie 1">Bergerie 1</option>
                    <option value="Bergerie 2">Bergerie 2</option>
                    <option value="Tunnel 1">Tunnel 1</option>
                    <option value="Tunnel 2">Tunnel 2</option>
                    <option value="Ensemble">Ensemble emplacements</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Lot (optionnel)</label>
                <input type="text" class="form-input" placeholder="Tous lots" id="feedingLot">
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Foin (bottes)</label>
                    <input type="number" class="form-input" min="0" value="0" id="feedingHay">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Paille (bottes)</label>
                    <input type="number" class="form-input" min="0" value="0" id="feedingStraw">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Aliment 1er (kg)</label>
                    <input type="number" class="form-input" min="0" value="0" id="feedingFeed1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Aliment 2e (kg)</label>
                    <input type="number" class="form-input" min="0" value="0" id="feedingFeed2">
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="addFeeding()">Enregistrer</button>
                <button class="btn btn-secondary" onclick="closeFeedingModal()">Annuler</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Variables globales
    var animals = [];
    var feedingRecords = [];
    var currentView = 'inventory';
    var currentEditingAnimal = null;
    var deferredPrompt;

    // Données d'exemple
    var sampleAnimals = [
        {id: '001', entryDate: '2024-10-30', sex: 'Mâle', lot: 'Béliers moins 1 an', breeder: 'Jacques SANTINI', location: 'Bergerie 1'},
        {id: '002', entryDate: '2024-10-30', sex: 'Mâle', lot: 'Béliers moins 1 an', breeder: 'Jacques SANTINI', location: 'Bergerie 1'},
        {id: '003', entryDate: '2024-11-13', sex: 'Mâle', lot: 'Béliers moins 1 an', breeder: 'Bernard ROSSI', location: 'Bergerie 1'},
        {id: '004', entryDate: '2024-10-06', sex: 'Femelle', lot: 'Agnelles de pensions', breeder: 'Toussaint CIPRIANI', location: 'Bergerie 2'},
        {id: '005', entryDate: '2024-10-23', sex: 'Femelle', lot: 'Agnelles de pensions', breeder: 'Jean-Pierre PAOLINI', location: 'Bergerie 2'},
        {id: '006', entryDate: '2024-10-06', sex: 'Mâle', lot: 'Béliers adultes de pension', breeder: 'Jean MARTIN', location: 'Tunnel 1'},
        {id: '007', entryDate: '2024-11-02', sex: 'Mâle', lot: 'Béliers moins 1 an', breeder: 'Serge MATTEI', location: 'Bergerie 1'},
        {id: '008', entryDate: '2024-11-06', sex: 'Mâle', lot: 'Béliers adultes de pension', breeder: 'Barthélémy DONATI', location: 'Tunnel 1'}
    ];

    var sampleFeeding = [
        {id: 1, date: '2024-10-05', location: 'Ensemble', lot: 'Tous lots', hay: 1, straw: 1, feed1stAge: 200, feed2ndAge: 0},
        {id: 2, date: '2024-10-06', location: 'Ensemble', lot: 'Tous lots', hay: 1, straw: 0, feed1stAge: 200, feed2ndAge: 0},
        {id: 3, date: '2024-10-07', location: 'Ensemble', lot: 'Tous lots', hay: 2, straw: 1, feed1stAge: 200, feed2ndAge: 0},
        {id: 4, date: '2024-10-08', location: 'Ensemble', lot: 'Tous lots', hay: 2, straw: 0, feed1stAge: 250, feed2ndAge: 0},
        {id: 5, date: '2024-10-09', location: 'Ensemble', lot: 'Tous lots', hay: 2, straw: 0, feed1stAge: 250, feed2ndAge: 0}
    ];

    // PWA Installation
    window.addEventListener('beforeinstallprompt', function(e) {
        e.preventDefault();
        deferredPrompt = e;
        showInstallBanner();
    });

    window.addEventListener('appinstalled', function(e) {
        hideInstallBanner();
        showNotification('Application installée avec succès!', 'success');
    });

    function showInstallBanner() {
        setTimeout(function() {
            document.getElementById('installBanner').classList.add('show');
        }, 3000);
    }

    function hideInstallBanner() {
        document.getElementById('installBanner').classList.remove('show');
    }

    function installApp() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(function(choiceResult) {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                }
                deferredPrompt = null;
            });
        }
        hideInstallBanner();
    }

    function dismissInstall() {
        hideInstallBanner();
    }

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('sw.js').then(function(registration) {
                console.log('ServiceWorker registration successful');
            }, function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        try {
            console.log('Démarrage Gestion Cheptel Pro...');
            loadData();
            updateDisplay();
            setTodayDates();
            showNotification('Application prête', 'success');
        } catch (error) {
            console.error('Erreur initialisation:', error);
            showNotification('Erreur de démarrage', 'error');
        }
    });

    function setTodayDates() {
        try {
            var today = new Date().toISOString().split('T')[0];
            var dateInputs = ['inputDate', 'exitDate', 'feedingDate'];
            dateInputs.forEach(function(id) {
                var element = document.getElementById(id);
                if (element) element.value = today;
            });
        } catch (error) {
            console.error('Erreur dates:', error);
        }
    }

    function showNotification(message, type) {
        try {
            var existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            var notification = document.createElement('div');
            notification.className = 'notification ' + type;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(function() {
                notification.classList.add('show');
            }, 100);

            setTimeout(function() {
                notification.classList.remove('show');
                setTimeout(function() {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        } catch (error) {
            console.error('Erreur notification:', error);
        }
    }

    // Navigation simplifiée
    function showView(viewName) {
        // Mettre à jour la variable globale
        currentView = viewName;
        
        // Retirer la classe active de tous les boutons
        var buttons = document.querySelectorAll('.nav-btn');
        buttons.forEach(function(btn) {
            btn.classList.remove('active');
        });
        
        // Ajouter la classe active au bon bouton
        if (viewName === 'inventory') {
            buttons[0].classList.add('active');
        } else if (viewName === 'feeding') {
            buttons[1].classList.add('active');
        } else if (viewName === 'stats') {
            buttons[2].classList.add('active');
        }
        
        // Masquer toutes les vues
        document.getElementById('view-inventory').classList.add('hidden');
        document.getElementById('view-feeding').classList.add('hidden');
        document.getElementById('view-stats').classList.add('hidden');
        
        // Afficher la bonne vue
        document.getElementById('view-' + viewName).classList.remove('hidden');
        
        // Mettre à jour l'affichage
        updateDisplay();
    }

    // Garder l'ancienne fonction pour compatibilité
    function switchView(view) {
        showView(view);
    }

    function fabAction() {
        try {
            if (currentView === 'inventory') {
                openAddModal();
            } else if (currentView === 'feeding') {
                openFeedingModal();
            } else {
                openAddModal();
            }
        } catch (error) {
            console.error('Erreur FAB:', error);
        }
    }

    // Gestion des modals
    function openAddModal() {
        document.getElementById('addModal').classList.remove('hidden');
        setTodayDates();
    }

    function closeAddModal() {
        document.getElementById('addModal').classList.add('hidden');
        resetAddForm();
    }

    function resetAddForm() {
        try {
            var inputs = ['inputId', 'inputBreeder'];
            inputs.forEach(function(id) {
                var element = document.getElementById(id);
                if (element) element.value = '';
            });
            var selects = ['inputSex', 'inputLot', 'inputLocation'];
            selects.forEach(function(id) {
                var element = document.getElementById(id);
                if (element) element.value = '';
            });
            var birthDate = document.getElementById('inputBirthDate');
            if (birthDate) birthDate.value = '';
        } catch (error) {
            console.error('Erreur reset form:', error);
        }
    }

    function editAnimal(animalId) {
        try {
            var animal = animals.find(function(a) { return a.id === animalId; });
            if (!animal) {
                showNotification('Animal non trouvé', 'error');
                return;
            }
            
            currentEditingAnimal = animalId;
            
            document.getElementById('editId').value = animal.id;
            document.getElementById('editDate').value = animal.entryDate || '';
            document.getElementById('editBirthDate').value = animal.birthDate || '';
            document.getElementById('editBreeder').value = animal.breeder || '';
            document.getElementById('editSex').value = animal.sex || '';
            document.getElementById('editLot').value = animal.lot || '';
            document.getElementById('editLocation').value = animal.location || '';
            
            document.getElementById('editModal').classList.remove('hidden');
        } catch (error) {
            console.error('Erreur édition:', error);
            showNotification('Erreur ouverture édition', 'error');
        }
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
        currentEditingAnimal = null;
    }

    function saveEditAnimal() {
        try {
            if (!currentEditingAnimal) return;

            var animalIndex = animals.findIndex(function(a) { return a.id === currentEditingAnimal; });
            if (animalIndex === -1) {
                showNotification('Animal non trouvé', 'error');
                return;
            }

            var lot = document.getElementById('editLot').value;
            var location = document.getElementById('editLocation').value;

            if (!lot || !location) {
                showNotification('Lot et emplacement obligatoires', 'error');
                return;
            }

            animals[animalIndex].entryDate = document.getElementById('editDate').value;
            animals[animalIndex].birthDate = document.getElementById('editBirthDate').value;
            animals[animalIndex].breeder = document.getElementById('editBreeder').value.trim();
            animals[animalIndex].sex = document.getElementById('editSex').value;
            animals[animalIndex].lot = lot;
            animals[animalIndex].location = location;

            closeEditModal();
            updateDisplay();
            saveData();
            showNotification('Animal modifié', 'success');
        } catch (error) {
            console.error('Erreur sauvegarde:', error);
            showNotification('Erreur sauvegarde', 'error');
        }
    }

    function openExitModal() {
        updateExitAnimalsList();
        document.getElementById('exitModal').classList.remove('hidden');
        setTodayDates();
    }

    function closeExitModal() {
        document.getElementById('exitModal').classList.add('hidden');
    }

    function updateExitAnimalsList() {
        try {
            var select = document.getElementById('exitAnimalSelect');
            if (!select) return;

            var presentAnimals = animals.filter(function(a) { return !a.exitDate; });
            select.innerHTML = '<option value="">Sélectionner</option>';
            
            presentAnimals.forEach(function(animal) {
                var option = document.createElement('option');
                option.value = animal.id;
                option.textContent = animal.id + ' - ' + animal.lot;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Erreur liste sortie:', error);
        }
    }

    function openFeedingModal() {
        document.getElementById('feedingModal').classList.remove('hidden');
        setTodayDates();
        resetFeedingForm();
    }

    function closeFeedingModal() {
        document.getElementById('feedingModal').classList.add('hidden');
    }

    function resetFeedingForm() {
        try {
            var selects = ['feedingLocation'];
            selects.forEach(function(id) {
                var element = document.getElementById(id);
                if (element) element.value = '';
            });
            var inputs = ['feedingLot'];
            inputs.forEach(function(id) {
                var element = document.getElementById(id);
                if (element) element.value = '';
            });
            var numbers = ['feedingHay', 'feedingStraw', 'feedingFeed1', 'feedingFeed2'];
            numbers.forEach(function(id) {
                var element = document.getElementById(id);
                if (element) element.value = '0';
            });
        } catch (error) {
            console.error('Erreur reset feeding:', error);
        }
    }

    // Actions principales
    function addAnimal() {
        try {
            var id = document.getElementById('inputId').value.trim();
            var date = document.getElementById('inputDate').value;
            var birthDate = document.getElementById('inputBirthDate').value;
            var breeder = document.getElementById('inputBreeder').value.trim();
            var sex = document.getElementById('inputSex').value;
            var lot = document.getElementById('inputLot').value;
            var location = document.getElementById('inputLocation').value;

            if (!id || !lot || !location) {
                showNotification('ID, lot et emplacement obligatoires', 'error');
                return;
            }

            var existingAnimal = animals.find(function(a) { return a.id === id; });
            if (existingAnimal) {
                showNotification('ID déjà existant', 'error');
                return;
            }

            animals.push({
                id: id,
                entryDate: date,
                birthDate: birthDate,
                breeder: breeder,
                sex: sex,
                lot: lot,
                location: location
            });
            
            closeAddModal();
            updateDisplay();
            saveData();
            showNotification('Animal ajouté', 'success');
        } catch (error) {
            console.error('Erreur ajout:', error);
            showNotification('Erreur ajout', 'error');
        }
    }

    function processExit() {
        try {
            var animalId = document.getElementById('exitAnimalSelect').value;
            var exitDate = document.getElementById('exitDate').value;
            var exitReason = document.getElementById('exitReason').value;

            if (!animalId || !exitDate || !exitReason) {
                showNotification('Tous les champs obligatoires', 'error');
                return;
            }

            var animalIndex = animals.findIndex(function(a) { return a.id === animalId; });
            if (animalIndex !== -1) {
                animals[animalIndex].exitDate = exitDate;
                animals[animalIndex].exitReason = exitReason;
                
                closeExitModal();
                updateDisplay();
                saveData();
                showNotification('Sortie enregistrée', 'success');
            }
        } catch (error) {
            console.error('Erreur sortie:', error);
            showNotification('Erreur sortie', 'error');
        }
    }

    function addFeeding() {
        try {
            var date = document.getElementById('feedingDate').value;
            var location = document.getElementById('feedingLocation').value;
            var lot = document.getElementById('feedingLot').value.trim();
            var hay = parseInt(document.getElementById('feedingHay').value) || 0;
            var straw = parseInt(document.getElementById('feedingStraw').value) || 0;
            var feed1stAge = parseInt(document.getElementById('feedingFeed1').value) || 0;
            var feed2ndAge = parseInt(document.getElementById('feedingFeed2').value) || 0;

            if (!date || !location) {
                showNotification('Date et emplacement obligatoires', 'error');
                return;
            }

            feedingRecords.push({
                id: Date.now(),
                date: date,
                location: location,
                lot: lot || 'Tous lots',
                hay: hay,
                straw: straw,
                feed1stAge: feed1stAge,
                feed2ndAge: feed2ndAge
            });
            
            closeFeedingModal();
            updateDisplay();
            saveFeedingData();
            showNotification('Nutrition enregistrée', 'success');
        } catch (error) {
            console.error('Erreur nutrition:', error);
            showNotification('Erreur nutrition', 'error');
        }
    }

    function importAnimals() {
        try {
            animals = sampleAnimals.slice();
            updateDisplay();
            saveData();
            showNotification(sampleAnimals.length + ' animaux importés', 'success');
        } catch (error) {
            console.error('Erreur import animaux:', error);
            showNotification('Erreur import', 'error');
        }
    }

    function importFeeding() {
        try {
            feedingRecords = sampleFeeding.slice();
            updateDisplay();
            saveFeedingData();
            showNotification(sampleFeeding.length + ' records nutrition importés', 'success');
        } catch (error) {
            console.error('Erreur import nutrition:', error);
            showNotification('Erreur import nutrition', 'error');
        }
    }

    function exportCSV() {
        try {
            if (animals.length === 0) {
                showNotification('Aucune donnée à exporter', 'error');
                return;
            }

            var headers = ['ID', 'Date_Entree', 'Date_Naissance', 'Sexe', 'Lot', 'Eleveur', 'Emplacement', 'Statut'];
            var csv = headers.join(',') + '\n';
            
            animals.forEach(function(animal) {
                var row = [
                    animal.id,
                    animal.entryDate || '',
                    animal.birthDate || '',
                    animal.sex || '',
                    animal.lot || '',
                    animal.breeder || '',
                    animal.location || '',
                    animal.exitDate ? 'Sorti' : 'Present'
                ];
                csv += row.join(',') + '\n';
            });

            var blob = new Blob([csv], { type: 'text/csv' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'gestion_cheptel_' + new Date().toISOString().slice(0,10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Export réussi', 'success');
        } catch (error) {
            console.error('Erreur export:', error);
            showNotification('Erreur export', 'error');
        }
    }

    // Affichage et mise à jour
    function updateDisplay() {
        try {
            updateTotalCount();
            
            if (currentView === 'inventory') {
                updateInventoryView();
            } else if (currentView === 'feeding') {
                updateFeedingView();
            } else if (currentView === 'stats') {
                updateStatsView();
            }
        } catch (error) {
            console.error('Erreur affichage:', error);
        }
    }

    function updateTotalCount() {
        try {
            var present = animals.filter(function(a) { return !a.exitDate; }).length;
            var element = document.getElementById('totalCount');
            if (element) element.textContent = present;
        } catch (error) {
            console.error('Erreur compteur:', error);
        }
    }

    function updateInventoryView() {
        try {
            var searchTerm = (document.getElementById('searchInput').value || '').toLowerCase();
            var filteredAnimals = animals.filter(function(animal) {
                if (!searchTerm) return true;
                return animal.id.toLowerCase().includes(searchTerm) ||
                       (animal.lot && animal.lot.toLowerCase().includes(searchTerm)) ||
                       (animal.location && animal.location.toLowerCase().includes(searchTerm)) ||
                       (animal.breeder && animal.breeder.toLowerCase().includes(searchTerm));
            });

            var container = document.getElementById('animals-container');
            var empty = document.getElementById('empty-inventory');
            
            if (!container || !empty) return;

            if (filteredAnimals.length === 0 && animals.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                container.innerHTML = filteredAnimals.map(function(animal) {
                    var sexBadge = animal.sex ? 
                        '<div class="sex-badge ' + (animal.sex === 'Mâle' ? 'sex-male' : 'sex-female') + '">' +
                            (animal.sex === 'Mâle' ? '♂' : '♀') +
                        '</div>' : '';
                    
                    var exitBadge = animal.exitDate ? 
                        '<div class="exit-badge">Sorti - ' + animal.exitReason + '</div>' : '';
                    
                    var exitClass = animal.exitDate ? ' exited' : '';
                    
                    return '<div class="animal-card' + exitClass + '">' +
                        '<div class="animal-header">' +
                            '<div>' +
                                '<div class="animal-id">' + animal.id + '</div>' +
                                '<div class="animal-lot">' + (animal.lot || '') + '</div>' +
                                exitBadge +
                            '</div>' +
                            '<div style="display: flex; gap: 6px; align-items: center;">' +
                                sexBadge +
                                (!animal.exitDate ? '<button onclick="editAnimal(\'' + animal.id + '\')" class="btn btn-secondary btn-small">✏️</button>' : '') +
                            '</div>' +
                        '</div>' +
                        '<div class="animal-details">' +
                            '<div class="detail-item">' +
                                '<div class="detail-label">Emplacement</div>' +
                                '<div class="detail-value">' + (animal.location || '') + '</div>' +
                            '</div>' +
                            '<div class="detail-item">' +
                                '<div class="detail-label">Entrée</div>' +
                                '<div class="detail-value">' + (animal.entryDate || 'Non renseigné') + '</div>' +
                            '</div>' +
                            (animal.birthDate ? 
                                '<div class="detail-item">' +
                                    '<div class="detail-label">Naissance</div>' +
                                    '<div class="detail-value">' + animal.birthDate + '</div>' +
                                '</div>' : '') +
                            (animal.breeder ? 
                                '<div class="detail-item" style="grid-column: 1 / -1;">' +
                                    '<div class="detail-label">Éleveur</div>' +
                                    '<div class="detail-value">' + animal.breeder + '</div>' +
                                '</div>' : '') +
                            (animal.exitDate ? 
                                '<div class="detail-item">' +
                                    '<div class="detail-label">Sortie</div>' +
                                    '<div class="detail-value" style="color: #dc2626;">' + animal.exitDate + '</div>' +
                                '</div>' : '') +
                        '</div>' +
                    '</div>';
                }).join('');
            }
        } catch (error) {
            console.error('Erreur inventory view:', error);
        }
    }

    function updateFeedingView() {
        try {
            var container = document.getElementById('feeding-container');
            var empty = document.getElementById('empty-feeding');
            
            if (!container || !empty) return;

            if (feedingRecords.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                var sortedRecords = feedingRecords.slice().sort(function(a, b) {
                    return new Date(b.date) - new Date(a.date);
                });
                
                container.innerHTML = sortedRecords.map(function(record) {
                    var items = [
                        {key: 'hay', label: 'Foin', unit: 'bottes'},
                        {key: 'straw', label: 'Paille', unit: 'bottes'},
                        {key: 'feed1stAge', label: 'Aliment 1er', unit: 'kg'},
                        {key: 'feed2ndAge', label: 'Aliment 2e', unit: 'kg'}
                    ].filter(function(item) { return record[item.key] > 0; });
                    
                    return '<div style="background:white;border:1px solid #e2e8f0;border-radius:10px;padding:16px;margin-bottom:12px;border-left:4px solid #059669;">' +
                        '<div style="margin-bottom:12px;">' +
                            '<div style="font-size:16px;font-weight:700;color:#1e293b;">' + record.location + '</div>' +
                            '<div style="color:#059669;font-weight:600;font-size:14px;margin-top:2px;">' + record.date + '</div>' +
                        '</div>' +
                        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:8px;">' +
                            items.map(function(item) {
                                return '<div style="background:#f0fdf4;border:1px solid #bbf7d0;padding:8px 4px;border-radius:6px;text-align:center;">' +
                                    '<div style="font-size:10px;color:#166534;margin-bottom:2px;">' + item.label + '</div>' +
                                    '<div style="font-size:13px;font-weight:700;color:#059669;">' + record[item.key] + ' ' + item.unit + '</div>' +
                                '</div>';
                            }).join('') +
                        '</div>' +
                    '</div>';
                }).join('');
            }
        } catch (error) {
            console.error('Erreur feeding view:', error);
        }
    }

    function updateStatsView() {
        try {
            var total = animals.length;
            var present = animals.filter(function(a) { return !a.exitDate; }).length;
            var exited = total - present;
            var males = animals.filter(function(a) { return a.sex === 'Mâle' && !a.exitDate; }).length;
            var females = animals.filter(function(a) { return a.sex === 'Femelle' && !a.exitDate; }).length;

            // Mettre à jour les statistiques
            var statTotal = document.getElementById('stat-total');
            var statPresent = document.getElementById('stat-present');
            var statExited = document.getElementById('stat-exited');
            var statMales = document.getElementById('stat-males');
            var statFemales = document.getElementById('stat-females');

            if (statTotal) statTotal.textContent = total;
            if (statPresent) statPresent.textContent = present;
            if (statExited) statExited.textContent = exited;
            if (statMales) statMales.textContent = males;
            if (statFemales) statFemales.textContent = females;

            // Répartition par lot
            var lots = {};
            animals.filter(function(a) { return !a.exitDate; }).forEach(function(animal) {
                if (animal.lot) {
                    lots[animal.lot] = (lots[animal.lot] || 0) + 1;
                }
            });

            var lotsContainer = document.getElementById('lots-breakdown');
            if (lotsContainer) {
                if (Object.keys(lots).length === 0) {
                    lotsContainer.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">Aucune donnée disponible</p>';
                } else {
                    lotsContainer.innerHTML = Object.keys(lots).map(function(lot) {
                        return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">' +
                            '<span>' + lot + '</span>' +
                            '<span style="font-weight: 700; color: #2563eb;">' + lots[lot] + '</span>' +
                        '</div>';
                    }).join('');
                }
            }

            // Causes de sortie
            var exitReasons = {};
            animals.filter(function(a) { return a.exitDate; }).forEach(function(animal) {
                if (animal.exitReason) {
                    exitReasons[animal.exitReason] = (exitReasons[animal.exitReason] || 0) + 1;
                }
            });

            var exitContainer = document.getElementById('exit-reasons');
            if (exitContainer) {
                if (Object.keys(exitReasons).length === 0) {
                    exitContainer.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">Aucune sortie enregistrée</p>';
                } else {
                    exitContainer.innerHTML = Object.keys(exitReasons).map(function(reason) {
                        return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">' +
                            '<span>' + reason + '</span>' +
                            '<span style="font-weight: 700; color: #dc2626;">' + exitReasons[reason] + '</span>' +
                        '</div>';
                    }).join('');
                }
            }

            // Message d'encouragement si pas d'animaux
            if (total === 0) {
                if (lotsContainer) {
                    lotsContainer.innerHTML = '<div style="text-align: center; padding: 20px;">' +
                        '<p style="color: #64748b; margin-bottom: 10px;">Aucun animal dans le cheptel</p>' +
                        '<button class="btn btn-primary" onclick="switchView(\'inventory\')">Ajouter des animaux</button>' +
                    '</div>';
                }
            }
        } catch (error) {
            console.error('Erreur stats view:', error);
        }
    }

    // Sauvegarde et chargement des données
    function saveData() {
        try {
            localStorage.setItem('cheptel_animals', JSON.stringify(animals));
        } catch (error) {
            console.error('Erreur sauvegarde:', error);
        }
    }

    function saveFeedingData() {
        try {
            localStorage.setItem('cheptel_feeding', JSON.stringify(feedingRecords));
        } catch (error) {
            console.error('Erreur sauvegarde feeding:', error);
        }
    }

    function loadData() {
        try {
            var savedAnimals = localStorage.getItem('cheptel_animals');
            if (savedAnimals) {
                animals = JSON.parse(savedAnimals);
            }

            var savedFeeding = localStorage.getItem('cheptel_feeding');
            if (savedFeeding) {
                feedingRecords = JSON.parse(savedFeeding);
            }
        } catch (error) {
            console.error('Erreur chargement:', error);
            animals = [];
            feedingRecords = [];
        }
    }

    // Gestion des clics en dehors des modales
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            closeAddModal();
            closeEditModal();
            closeExitModal();
            closeFeedingModal();
        }
    });

    // Gestion de la touche Échap
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeAddModal();
            closeEditModal();
            closeExitModal();
            closeFeedingModal();
        }
    });

    // Style d'installation pour PWA ajouté au CSS
    var additionalCSS = `
    .install-banner {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #2563eb;
        color: white;
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transform: translateY(100%);
        transition: transform 0.3s ease;
        z-index: 1001;
    }
    
    .install-banner.show {
        transform: translateY(0);
    }
    
    .install-text {
        font-size: 14px;
        font-weight: 600;
    }
    
    .install-btn {
        background: white;
        color: #2563eb;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
    }
    `;
    
    // Ajouter le CSS au head si pas déjà présent
    if (!document.querySelector('#pwa-css')) {
        var style = document.createElement('style');
        style.id = 'pwa-css';
        style.textContent = additionalCSS;
        document.head.appendChild(style);
    }
</script>
</body>
</html><!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Application de gestion de cheptel moderne et professionnelle">
    
    <title>Gestion Cheptel Pro</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Cheptel Pro">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjMjU2M2ViIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0wIDE4Yy00LjQyIDAtOC0zLjU4LTgtOHMzLjU4LTggOC04IDggMy41OCA4IDgtMy41OCA4LTggOHoiLz48L3N2Zz4=">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjMjU2M2ViIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0wIDE4Yy00LjQyIDAtOC0zLjU4LTgtOHMzLjU4LTggOC04IDggMy41OCA4IDgtMy41OCA4LTggOHoiLz48L3N2Zz4=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            overflow-x: hidden;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
            background: #f8fafc; 
            color: #1e293b;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header { 
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px; 
        }
        
        .title { 
            font-size: 22px; 
            font-weight: 600; 
            line-height: 1.2;
        }
        
        .subtitle { 
            font-size: 13px; 
            opacity: 0.9; 
            margin-top: 2px; 
        }
        
        .stat-badge { 
            background: rgba(255,255,255,0.2); 
            padding: 8px 12px; 
            border-radius: 10px; 
            text-align: center;
            min-width: 60px;
        }
        
        .stat-number { 
            font-size: 18px; 
            font-weight: 700; 
            line-height: 1;
        }
        
        .stat-label { 
            font-size: 10px; 
            opacity: 0.8; 
            text-transform: uppercase; 
            margin-top: 2px;
        }
        
        .nav { 
            display: flex; 
            gap: 4px; 
        }
        
        .nav-btn { 
            flex: 1; 
            padding: 12px 6px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
            min-height: 44px;
            text-align: center;
        }
        
        .nav-btn.active { 
            background: rgba(255,255,255,0.9); 
            color: #2563eb; 
        }
        
        .content { 
            flex: 1;
            padding: 16px; 
            padding-bottom: 80px; 
        }
        
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 16px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 16px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: border-color 0.2s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #2563eb;
        }
        
        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-size: 16px;
        }
        
        .btn-group { 
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap; 
            margin-bottom: 16px; 
        }
        
        .btn { 
            padding: 12px 16px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
        }
        
        .btn:active { 
            transform: scale(0.98); 
        }
        
        .btn-primary { background: #2563eb; color: white; }
        .btn-success { background: #059669; color: white; }
        .btn-warning { background: #d97706; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-secondary { background: #64748b; color: white; }
        
        .animal-card { 
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px; 
            padding: 16px; 
            margin-bottom: 12px;
            transition: box-shadow 0.2s ease;
        }
        
        .animal-card.exited {
            opacity: 0.7;
            border-left: 4px solid #dc2626;
        }
        
        .animal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 12px; 
        }
        
        .animal-id { 
            font-size: 18px; 
            font-weight: 700; 
            color: #1e293b; 
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        .animal-lot { 
            color: #2563eb; 
            font-weight: 600; 
            font-size: 14px; 
            line-height: 1.2;
        }
        
        .sex-badge { 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 16px; 
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .sex-male { background: #dbeafe; color: #2563eb; }
        .sex-female { background: #fce7f3; color: #db2777; }
        
        .exit-badge {
            background: #fee2e2;
            color: #dc2626;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 6px;
            display: inline-block;
        }
        
        .animal-details { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            font-size: 14px; 
        }
        
        .detail-label { 
            color: #64748b; 
            margin-bottom: 2px; 
            font-size: 12px; 
            line-height: 1.2;
        }
        .detail-value { 
            font-weight: 600; 
            color: #1e293b; 
            line-height: 1.2;
        }
        
        .btn-small {
            padding: 6px 8px;
            font-size: 11px;
            min-height: 32px;
            border-radius: 6px;
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin-bottom: 16px; 
        }
        
        .stats-card { 
            background: white; 
            padding: 16px 12px; 
            border-radius: 10px; 
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }
        
        .stats-number { 
            font-size: 22px; 
            font-weight: 800; 
            margin-bottom: 4px;
            line-height: 1;
        }
        
        .stats-label { 
            font-size: 11px; 
            color: #64748b; 
            text-transform: uppercase;
            font-weight: 600;
            line-height: 1.1;
        }
        
        .text-blue { color: #2563eb; }
        .text-green { color: #059669; }
        .text-red { color: #dc2626; }
        .text-purple { color: #7c3aed; }
        
        .modal { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.5); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }
        
        .modal-content { 
            background: white; 
            border-radius: 16px; 
            width: 100%; 
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px 20px 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            line-height: 1.2;
        }
        
        .close-btn {
            background: #f1f5f9;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            color: #64748b;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .modal-body {
            padding: 0 20px 20px 20px;
        }
        
        .form-group { 
            margin-bottom: 16px; 
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
            line-height: 1.2;
        }
        
        .form-input, .form-select { 
            width: 100%; 
            padding: 12px 16px; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            font-size: 16px;
            background: white;
            transition: border-color 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2563eb;
        }
        
        .form-input:disabled {
            background: #f8fafc;
            color: #64748b;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .empty-state { 
            text-align: center; 
            padding: 40px 20px;
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            margin: 16px 0;
        }
        
        .empty-icon { 
            font-size: 48px; 
            margin-bottom: 16px;
            opacity: 0.6;
        }
        
        .empty-title { 
            font-size: 18px; 
            font-weight: 600; 
            color: #1e293b; 
            margin-bottom: 8px; 
            line-height: 1.3;
        }
        
        .empty-text { 
            color: #64748b; 
            margin-bottom: 16px; 
            font-size: 14px;
            line-height: 1.4;
        }
        
        .fab { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            width: 56px; 
            height: 56px; 
            background: #2563eb; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 24px; 
            z-index: 50;
            transition: all 0.2s ease;
        }
        
        .hidden { display: none !important; }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 14px;
            max-width: 90%;
            text-align: center;
        }
        
        .notification.success { background: #059669; }
        .notification.error { background: #dc2626; }
        .notification.show { opacity: 1; }
        
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2563eb;
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1001;
        }
        
        .install-banner.show {
            transform: translateY(0);
        }
        
        .install-text {
            font-size: 14px;
            font-weight: 600;
        }
        
        .install-btn {
            background: white;
            color: #2563eb;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        
        @media (max-width: 640px) {
            .header { padding: 12px; }
            .content { padding: 12px; padding-bottom: 80px; }
            .animal-details { grid-template-columns: 1fr; gap: 8px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .btn-group { gap: 6px; }
            .btn { padding: 10px 12px; font-size: 13px; }
            .form-grid { grid-template-columns: 1fr; }
            .modal { padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1 class="title">Gestion Cheptel</h1>
                    <p class="subtitle">Élevage moderne et connecté</p>
                </div>
                <div class="stat-badge">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Présents</div>
                </div>
            </div>
            
            <nav class="nav">
                <button class="nav-btn active" onclick="showView('inventory')">🐑 Animaux</button>
                <button class="nav-btn" onclick="showView('feeding')">🌾 Nutrition</button>
                <button class="nav-btn" onclick="showView('stats')">📈 Données</button>
            </nav>
        </div>
        
        <div class="content">
            <!-- Vue Inventaire -->
            <div id="view-inventory">
                <div class="card">
                    <div class="search-box">
                        <div class="search-icon">🔍</div>
                        <input type="text" class="search-input" placeholder="Rechercher..." id="searchInput" oninput="updateDisplay()">
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="openAddModal()">✚ Ajouter</button>
                        <button class="btn btn-danger" onclick="openExitModal()">✖ Sortie</button>
                        <button class="btn btn-success" onclick="importAnimals()">⬇ Import</button>
                        <button class="btn btn-warning" onclick="exportCSV()">⬆ Export</button>
                    </div>
                </div>
                
                <div id="animals-container"></div>
                
                <div id="empty-inventory" class="empty-state">
                    <div class="empty-icon">🐄</div>
                    <h3 class="empty-title">Aucun animal enregistré</h3>
                    <p class="empty-text">Commencez par importer des données ou ajouter un nouvel animal</p>
                    <button class="btn btn-success" onclick="importAnimals()">⬇ Importer des exemples</button>
                </div>
            </div>
            
            <!-- Vue Statistiques -->
            <div id="view-stats" class="hidden">
                <div class="card">
                    <h2 style="color: #2563eb; margin-bottom: 8px; font-size: 18px; font-weight: 700;">📈 Statistiques</h2>
                    <p style="color: #64748b; font-size: 13px;">Vue d'ensemble de votre cheptel</p>
                </div>
                
                <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px;">
                    <div class="stats-card">
                        <div class="stats-number text-blue" id="stat-total">0</div>
                        <div class="stats-label">Total</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number text-green" id="stat-present">0</div>
                        <div class="stats-label">Présents</div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stats-card">
                        <div class="stats-number text-red" id="stat-exited">0</div>
                        <div class="stats-label">Sortis</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number text-blue" id="stat-males">0</div>
                        <div class="stats-label">Mâles</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number text-purple" id="stat-females">0</div>
                        <div class="stats-label">Femelles</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 style="font-weight: 700; margin-bottom: 12px; color: #1e293b; font-size: 16px;">Répartition par lot</h3>
                    <div id="lots-breakdown"></div>
                </div>
                
                <div class="card">
                    <h3 style="font-weight: 700; margin-bottom: 12px; color: #1e293b; font-size: 16px;">Causes de sortie</h3>
                    <div id="exit-reasons"></div>
                </div>
            </div>
        </div>
        
        <button class="fab" onclick="fabAction()">✚</button>
    </div>

    <!-- Install Banner -->
    <div id="installBanner" class="install-banner">
        <div class="install-text">Installer l'application sur votre appareil</div>
        <button class="install-btn" onclick="installApp()">Installer</button>
        <button onclick="dismissInstall()" style="background: transparent; border: none; color: white; padding: 8px; cursor: pointer;">✕</button>
    </div>

    <!-- Modals -->
    <div id="addModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ajouter animal</h2>
                <button class="close-btn" onclick="closeAddModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ID animal *</label>
                    <input type="text" class="form-input" placeholder="Ex: 001, A123..." id="inputId">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Date d'entrée</label>
                    <input type="date" class="form-input" id="inputDate">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nom éleveur</label>
                    <input type="text" class="form-input" placeholder="Ex: Jacques SANTINI" id="inputBreeder">
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Sexe</label>
                        <select class="form-select" id="inputSex">
                            <option value="">Sélectionner</option>
                            <option value="Mâle">Mâle</option>
                            <option value="Femelle">Femelle</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Lot *</label>
                        <select class="form-select" id="inputLot">
                            <option value="">Sélectionner</option>
                            <option value="Béliers moins 1 an">Béliers moins 1 an</option>
                            <option value="Béliers plus 1 an">Béliers plus 1 an</option>
                            <option value="Agnelles de pensions">Agnelles de pensions</option>
                            <option value="Béliers adultes de pension">Béliers adultes de pension</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emplacement *</label>
                    <select class="form-select" id="inputLocation">
                        <option value="">Sélectionner</option>
                        <option value="Bergerie 1">Bergerie 1</option>
                        <option value="Bergerie 2">Bergerie 2</option>
                        <option value="Tunnel 1">Tunnel 1</option>
                        <option value="Tunnel 2">Tunnel 2</option>
                        <option value="Dactyle 1">Dactyle 1</option>
                        <option value="Dactyle 2">Dactyle 2</option>
                    </select>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="addAnimal()">Ajouter</button>
                    <button class="btn btn-secondary" onclick="closeAddModal()">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <div id="exitModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Sortie animal</h2>
                <button class="close-btn" onclick="closeExitModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Animal à sortir *</label>
                    <select class="form-select" id="exitAnimalSelect">
                        <option value="">Sélectionner</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Date sortie *</label>
                    <input type="date" class="form-input" id="exitDate">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Cause sortie *</label>
                    <select class="form-select" id="exitReason">
                        <option value="">Sélectionner</option>
                        <option value="MORT">MORT</option>
                        <option value="REFORME">RÉFORME</option>
                        <option value="VENTE">VENTE</option>
                        <option value="TRANSFERT">TRANSFERT</option>
                    </select>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-danger" onclick="processExit()">Enregistrer</button>
                    <button class="btn btn-secondary" onclick="closeExitModal()">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        var animals = [];
        var currentView = 'inventory';
        var currentEditingAnimal = null;
        var deferredPrompt;

        // Données d'exemple
        var sampleAnimals = [
            {id: '001', entryDate: '2024-10-30', sex: 'Mâle', lot: 'Béliers moins 1 an', breeder: 'Jacques SANTINI', location: 'Bergerie 1'},
            {id: '002', entryDate: '2024-10-30', sex: 'Mâle', lot: 'Béliers moins 1 an', breeder: 'Jacques SANTINI', location: 'Bergerie 1'},
            {id: '003', entryDate: '2024-11-13', sex: 'Mâle', lot: 'Béliers moins 1 an', breeder: 'Bernard ROSSI', location: 'Bergerie 1'},
            {id: '004', entryDate: '2024-10-06', sex: 'Femelle', lot: 'Agnelles de pensions', breeder: 'Toussaint CIPRIANI', location: 'Bergerie 2'},
            {id: '005', entryDate: '2024-10-23', sex: 'Femelle', lot: 'Agnelles de pensions', breeder: 'Jean-Pierre PAOLINI', location: 'Bergerie 2'},
            {id: '006', entryDate: '2024-10-06', sex: 'Mâle', lot: 'Béliers adultes de pension', breeder: 'Jean MARTIN', location: 'Tunnel 1'},
            {id: '007', entryDate: '2024-11-02', sex: 'Mâle', lot: 'Béliers moins 1 an', breeder: 'Serge MATTEI', location: 'Bergerie 1'},
            {id: '008', entryDate: '2024-11-06', sex: 'Mâle', lot: 'Béliers adultes de pension', breeder: 'Barthélémy DONATI', location: 'Tunnel 1'}
        ];

        // PWA Installation
        window.addEventListener('beforeinstallprompt', function(e) {
            e.preventDefault();
            deferredPrompt = e;
            showInstallBanner();
        });

        window.addEventListener('appinstalled', function(e) {
            hideInstallBanner();
            showNotification('Application installée avec succès!', 'success');
        });

        function showInstallBanner() {
            setTimeout(function() {
                document.getElementById('installBanner').classList.add('show');
            }, 3000);
        }

        function hideInstallBanner() {
            document.getElementById('installBanner').classList.remove('show');
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(function(choiceResult) {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                });
            }
            hideInstallBanner();
        }

        function dismissInstall() {
            hideInstallBanner();
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful');
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('Démarrage Gestion Cheptel Pro...');
                loadData();
                updateDisplay();
                setTodayDates();
                showNotification('Application prête', 'success');
            } catch (error) {
                console.error('Erreur initialisation:', error);
                showNotification('Erreur de démarrage', 'error');
            }
        });

        function setTodayDates() {
            try {
                var today = new Date().toISOString().split('T')[0];
                var dateInputs = ['inputDate', 'exitDate'];
                dateInputs.forEach(function(id) {
                    var element = document.getElementById(id);
                    if (element) element.value = today;
                });
            } catch (error) {
                console.error('Erreur dates:', error);
            }
        }

        function showNotification(message, type) {
            try {
                var existingNotification = document.querySelector('.notification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                var notification = document.createElement('div');
                notification.className = 'notification ' + type;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(function() {
                    notification.classList.add('show');
                }, 100);

                setTimeout(function() {
                    notification.classList.remove('show');
                    setTimeout(function() {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            } catch (error) {
                console.error('Erreur notification:', error);
            }
        }

        // Navigation
        function switchView(view) {
            try {
                currentView = view;
                
                var navButtons = document.querySelectorAll('.nav-btn');
                navButtons.forEach(function(btn) {
                    btn.classList.remove('active');
                });
                
                var activeBtn = Array.from(navButtons).find(function(btn) {
                    return btn.textContent.toLowerCase().includes(view === 'inventory' ? 'animaux' : 'données');
                });
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
                
                var views = ['inventory', 'stats'];
                views.forEach(function(v) {
                    var element = document.getElementById('view-' + v);
                    if (element) {
                        element.classList.toggle('hidden', v !== view);
                    }
                });
                
                updateDisplay();
            } catch (error) {
                console.error('Erreur navigation:', error);
            }
        }

        function fabAction() {
            try {
                openAddModal();
            } catch (error) {
                console.error('Erreur FAB:', error);
            }
        }

        // Gestion des modals
        function openAddModal() {
            document.getElementById('addModal').classList.remove('hidden');
            setTodayDates();
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.add('hidden');
            resetAddForm();
        }

        function resetAddForm() {
            try {
                var inputs = ['inputId', 'inputBreeder'];
                inputs.forEach(function(id) {
                    var element = document.getElementById(id);
                    if (element) element.value = '';
                });
                var selects = ['inputSex', 'inputLot', 'inputLocation'];
                selects.forEach(function(id) {
                    var element = document.getElementById(id);
                    if (element) element.value = '';
                });
            } catch (error) {
                console.error('Erreur reset form:', error);
            }
        }

        function editAnimal(animalId) {
            try {
                var animal = animals.find(function(a) { return a.id === animalId; });
                if (!animal) {
                    showNotification('Animal non trouvé', 'error');
                    return;
                }
                
                currentEditingAnimal = animalId;
                
                document.getElementById('inputId').value = animal.id;
                document.getElementById('inputDate').value = animal.entryDate || '';
                document.getElementById('inputBreeder').value = animal.breeder || '';
                document.getElementById('inputSex').value = animal.sex || '';
                document.getElementById('inputLot').value = animal.lot || '';
                document.getElementById('inputLocation').value = animal.location || '';
                
                openAddModal();
            } catch (error) {
                console.error('Erreur édition:', error);
                showNotification('Erreur ouverture édition', 'error');
            }
        }

        function openExitModal() {
            updateExitAnimalsList();
            document.getElementById('exitModal').classList.remove('hidden');
            setTodayDates();
        }

        function closeExitModal() {
            document.getElementById('exitModal').classList.add('hidden');
        }

        function updateExitAnimalsList() {
            try {
                var select = document.getElementById('exitAnimalSelect');
                if (!select) return;

                var presentAnimals = animals.filter(function(a) { return !a.exitDate; });
                select.innerHTML = '<option value="">Sélectionner</option>';
                
                presentAnimals.forEach(function(animal) {
                    var option = document.createElement('option');
                    option.value = animal.id;
                    option.textContent = animal.id + ' - ' + animal.lot;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur liste sortie:', error);
            }
        }

        // Actions principales
        function addAnimal() {
            try {
                var id = document.getElementById('inputId').value.trim();
                var date = document.getElementById('inputDate').value;
                var breeder = document.getElementById('inputBreeder').value.trim();
                var sex = document.getElementById('inputSex').value;
                var lot = document.getElementById('inputLot').value;
                var location = document.getElementById('inputLocation').value;

                if (!id || !lot || !location) {
                    showNotification('ID, lot et emplacement obligatoires', 'error');
                    return;
                }

                if (currentEditingAnimal) {
                    // Mode édition
                    var animalIndex = animals.findIndex(function(a) { return a.id === currentEditingAnimal; });
                    if (animalIndex !== -1) {
                        animals[animalIndex].entryDate = date;
                        animals[animalIndex].breeder = breeder;
                        animals[animalIndex].sex = sex;
                        animals[animalIndex].lot = lot;
                        animals[animalIndex].location = location;
                        showNotification('Animal modifié', 'success');
                    }
                    currentEditingAnimal = null;
                } else {
                    // Mode ajout
                    var existingAnimal = animals.find(function(a) { return a.id === id; });
                    if (existingAnimal) {
                        showNotification('ID déjà existant', 'error');
                        return;
                    }

                    animals.push({
                        id: id,
                        entryDate: date,
                        breeder: breeder,
                        sex: sex,
                        lot: lot,
                        location: location
                    });
                    showNotification('Animal ajouté', 'success');
                }
                
                closeAddModal();
                updateDisplay();
                saveData();
            } catch (error) {
                console.error('Erreur ajout:', error);
                showNotification('Erreur ajout', 'error');
            }
        }

        function processExit() {
            try {
                var animalId = document.getElementById('exitAnimalSelect').value;
                var exitDate = document.getElementById('exitDate').value;
                var exitReason = document.getElementById('exitReason').value;

                if (!animalId || !exitDate || !exitReason) {
                    showNotification('Tous les champs obligatoires', 'error');
                    return;
                }

                var animalIndex = animals.findIndex(function(a) { return a.id === animalId; });
                if (animalIndex !== -1) {
                    animals[animalIndex].exitDate = exitDate;
                    animals[animalIndex].exitReason = exitReason;
                    
                    closeExitModal();
                    updateDisplay();
                    saveData();
                    showNotification('Sortie enregistrée', 'success');
                }
            } catch (error) {
                console.error('Erreur sortie:', error);
                showNotification('Erreur sortie', 'error');
            }
        }

        function importAnimals() {
            try {
                animals = sampleAnimals.slice();
                updateDisplay();
                saveData();
                showNotification(sampleAnimals.length + ' animaux importés', 'success');
            } catch (error) {
                console.error('Erreur import animaux:', error);
                showNotification('Erreur import', 'error');
            }
        }

        function exportCSV() {
            try {
                if (animals.length === 0) {
                    showNotification('Aucune donnée à exporter', 'error');
                    return;
                }

                var headers = ['ID', 'Date_Entree', 'Sexe', 'Lot', 'Eleveur', 'Emplacement', 'Statut'];
                var csv = headers.join(',') + '\n';
                
                animals.forEach(function(animal) {
                    var row = [
                        animal.id,
                        animal.entryDate || '',
                        animal.sex || '',
                        animal.lot || '',
                        animal.breeder || '',
                        animal.location || '',
                        animal.exitDate ? 'Sorti' : 'Present'
                    ];
                    csv += row.join(',') + '\n';
                });

                var blob = new Blob([csv], { type: 'text/csv' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'gestion_cheptel_' + new Date().toISOString().slice(0,10) + '.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('Export réussi', 'success');
            } catch (error) {
                console.error('Erreur export:', error);
                showNotification('Erreur export', 'error');
            }
        }

        // Affichage et mise à jour
        function updateDisplay() {
            try {
                updateTotalCount();
                
                if (currentView === 'inventory') {
                    updateInventoryView();
                } else if (currentView === 'stats') {
                    updateStatsView();
                }
            } catch (error) {
                console.error('Erreur affichage:', error);
            }
        }

        function updateTotalCount() {
            try {
                var present = animals.filter(function(a) { return !a.exitDate; }).length;
                var element = document.getElementById('totalCount');
                if (element) element.textContent = present;
            } catch (error) {
                console.error('Erreur compteur:', error);
            }
        }

        function updateInventoryView() {
            try {
                var searchTerm = (document.getElementById('searchInput').value || '').toLowerCase();
                var filteredAnimals = animals.filter(function(animal) {
                    if (!searchTerm) return true;
                    return animal.id.toLowerCase().includes(searchTerm) ||
                           (animal.lot && animal.lot.toLowerCase().includes(searchTerm)) ||
                           (animal.location && animal.location.toLowerCase().includes(searchTerm)) ||
                           (animal.breeder && animal.breeder.toLowerCase().includes(searchTerm));
                });

                var container = document.getElementById('animals-container');
                var empty = document.getElementById('empty-inventory');
                
                if (!container || !empty) return;

                if (filteredAnimals.length === 0 && animals.length === 0) {
                    container.innerHTML = '';
                    empty.classList.remove('hidden');
                } else {
                    empty.classList.add('hidden');
                    container.innerHTML = filteredAnimals.map(function(animal) {
                        var sexBadge = animal.sex ? 
                            '<div class="sex-badge ' + (animal.sex === 'Mâle' ? 'sex-male' : 'sex-female') + '">' +
                                (animal.sex === 'Mâle' ? '♂' : '♀') +
                            '</div>' : '';
                        
                        var exitBadge = animal.exitDate ? 
                            '<div class="exit-badge">Sorti - ' + animal.exitReason + '</div>' : '';
                        
                        var exitClass = animal.exitDate ? ' exited' : '';
                        
                        return '<div class="animal-card' + exitClass + '">' +
                            '<div class="animal-header">' +
                                '<div>' +
                                    '<div class="animal-id">' + animal.id + '</div>' +
                                    '<div class="animal-lot">' + (animal.lot || '') + '</div>' +
                                    exitBadge +
                                '</div>' +
                                '<div style="display: flex; gap: 6px; align-items: center;">' +
                                    sexBadge +
                                    (!animal.exitDate ? '<button onclick="editAnimal(\'' + animal.id + '\')" class="btn btn-secondary btn-small">✏️</button>' : '') +
                                '</div>' +
                            '</div>' +
                            '<div class="animal-details">' +
                                '<div class="detail-item">' +
                                    '<div class="detail-label">Emplacement</div>' +
                                    '<div class="detail-value">' + (animal.location || '') + '</div>' +
                                '</div>' +
                                '<div class="detail-item">' +
                                    '<div class="detail-label">Entrée</div>' +
                                    '<div class="detail-value">' + (animal.entryDate || 'Non renseigné') + '</div>' +
                                '</div>' +
                                (animal.breeder ? 
                                    '<div class="detail-item" style="grid-column: 1 / -1;">' +
                                        '<div class="detail-label">Éleveur</div>' +
                                        '<div class="detail-value">' + animal.breeder + '</div>' +
                                    '</div>' : '') +
                                (animal.exitDate ? 
                                    '<div class="detail-item">' +
                                        '<div class="detail-label">Sortie</div>' +
                                        '<div class="detail-value" style="color: #dc2626;">' + animal.exitDate + '</div>' +
                                    '</div>' : '') +
                            '</div>' +
                        '</div>';
                    }).join('');
                }
            } catch (error) {
                console.error('Erreur inventory view:', error);
            }
        }

        function updateStatsView() {
            try {
                var total = animals.length;
                var present = animals.filter(function(a) { return !a.exitDate; }).length;
                var exited = total - present;
                var males = animals.filter(function(a) { return a.sex === 'Mâle' && !a.exitDate; }).length;
                var females = animals.filter(function(a) { return a.sex === 'Femelle' && !a.exitDate; }).length;

                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-present').textContent = present;
                document.getElementById('stat-exited').textContent = exited;
                document.getElementById('stat-males').textContent = males;
                document.getElementById('stat-females').textContent = females;

                // Répartition par lot
                var lots = {};
                animals.filter(function(a) { return !a.exitDate; }).forEach(function(animal) {
                    if (animal.lot) {
                        lots[animal.lot] = (lots[animal.lot] || 0) + 1;
                    }
                });

                var lotsContainer = document.getElementById('lots-breakdown');
                if (lotsContainer) {
                    if (Object.keys(lots).length === 0) {
                        lotsContainer.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">Aucune donnée</p>';
                    } else {
                        lotsContainer.innerHTML = Object.keys(lots).map(function(lot) {
                            return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">' +
                                '<span>' + lot + '</span>' +
                                '<span style="font-weight: 700; color: #2563eb;">' + lots[lot] + '</span>' +
                            '</div>';
                        }).join('');
                    }
                }

                // Causes de sortie
                var exitReasons = {};
                animals.filter(function(a) { return a.exitDate; }).forEach(function(animal) {
                    if (animal.exitReason) {
                        exitReasons[animal.exitReason] = (exitReasons[animal.exitReason] || 0) + 1;
                    }
                });

                var exitContainer = document.getElementById('exit-reasons');
                if (exitContainer) {
                    if (Object.keys(exitReasons).length === 0) {
                        exitContainer.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">Aucune sortie enregistrée</p>';
                    } else {
                        exitContainer.innerHTML = Object.keys(exitReasons).map(function(reason) {
                            return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">' +
                                '<span>' + reason + '</span>' +
                                '<span style="font-weight: 700; color: #dc2626;">' + exitReasons[reason] + '</span>' +
                            '</div>';
                        }).join('');
                    }
                }
            } catch (error) {
                console.error('Erreur stats view:', error);
            }
        }

        // Sauvegarde et chargement des données
        function saveData() {
            try {
                localStorage.setItem('cheptel_animals', JSON.stringify(animals));
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
            }
        }

        function loadData() {
            try {
                var savedAnimals = localStorage.getItem('cheptel_animals');
                if (savedAnimals) {
                    animals = JSON.parse(savedAnimals);
                }
            } catch (error) {
                console.error('Erreur chargement:', error);
                animals = [];
            }
        }

        // Gestion des clics en dehors des modales
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                closeAddModal();
                closeExitModal();
            }
        });

        // Gestion de la touche Échap
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAddModal();
                closeExitModal();
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <title>Gestion Cheptel Pro</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
            background: #f8fafc; 
            color: #1e293b;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header { 
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
        }
        
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px; 
        }
        
        .title { 
            font-size: 22px; 
            font-weight: 600; 
        }
        
        .subtitle { 
            font-size: 13px; 
            opacity: 0.9; 
            margin-top: 2px; 
        }
        
        .stat-badge { 
            background: rgba(255,255,255,0.2); 
            padding: 8px 12px; 
            border-radius: 10px; 
            text-align: center;
            min-width: 60px;
        }
        
        .stat-number { 
            font-size: 18px; 
            font-weight: 700; 
        }
        
        .stat-label { 
            font-size: 10px; 
            opacity: 0.8; 
            text-transform: uppercase; 
            margin-top: 2px;
        }
        
        .nav { 
            display: flex; 
            gap: 4px; 
        }
        
        .nav-btn { 
            flex: 1; 
            padding: 12px 6px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
            min-height: 44px;
        }
        
        .nav-btn.active { 
            background: rgba(255,255,255,0.9); 
            color: #2563eb; 
        }
        
        .content { 
            flex: 1;
            padding: 16px; 
            padding-bottom: 80px; 
        }
        
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 16px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }
        
        .btn-group { 
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap; 
            margin-bottom: 16px; 
        }
        
        .btn { 
            padding: 12px 16px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex: 1;
        }
        
        .btn:hover { 
            opacity: 0.9; 
        }
        
        .btn-primary { background: #2563eb; color: white; }
        .btn-success { background: #059669; color: white; }
        .btn-warning { background: #d97706; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-secondary { background: #64748b; color: white; }
        
        .animal-card { 
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px; 
            padding: 16px; 
            margin-bottom: 12px;
        }
        
        .animal-card.exited {
            opacity: 0.7;
            border-left: 4px solid #dc2626;
        }
        
        .animal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 12px; 
        }
        
        .animal-id { 
            font-size: 18px; 
            font-weight: 700; 
            color: #1e293b; 
            margin-bottom: 4px;
        }
        
        .animal-lot { 
            color: #2563eb; 
            font-weight: 600; 
            font-size: 14px; 
        }
        
        .sex-badge { 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 16px; 
            font-weight: 700;
        }
        
        .sex-male { background: #dbeafe; color: #2563eb; }
        .sex-female { background: #fce7f3; color: #db2777; }
        
        .exit-badge {
            background: #fee2e2;
            color: #dc2626;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 6px;
        }
        
        .animal-details { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            font-size: 14px; 
        }
        
        .detail-label { 
            color: #64748b; 
            margin-bottom: 2px; 
            font-size: 12px; 
        }
        .detail-value { 
            font-weight: 600; 
            color: #1e293b; 
        }
        
        .btn-small {
            padding: 6px 8px;
            font-size: 11px;
            min-height: 32px;
            border-radius: 6px;
        }
        
        .modal { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.5); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }
        
        .modal-content { 
            background: white; 
            border-radius: 16px; 
            width: 100%; 
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px 20px 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }
        
        .close-btn {
            background: #f1f5f9;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            color: #64748b;
        }
        
        .modal-body {
            padding: 0 20px 20px 20px;
        }
        
        .form-group { 
            margin-bottom: 16px; 
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }
        
        .form-input, .form-select { 
            width: 100%; 
            padding: 12px 16px; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            font-size: 16px;
            background: white;
            transition: border-color 0.2s ease;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2563eb;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .empty-state { 
            text-align: center; 
            padding: 40px 20px;
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            margin: 16px 0;
        }
        
        .empty-icon { 
            font-size: 48px; 
            margin-bottom: 16px;
            opacity: 0.6;
        }
        
        .empty-title { 
            font-size: 18px; 
            font-weight: 600; 
            color: #1e293b; 
            margin-bottom: 8px; 
        }
        
        .empty-text { 
            color: #64748b; 
            margin-bottom: 16px; 
            font-size: 14px;
        }
        
        .fab { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            width: 56px; 
            height: 56px; 
            background: #2563eb; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 24px; 
            z-index: 50;
        }
        
        .hidden { display: none !important; }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 14px;
            max-width: 90%;
            text-align: center;
        }
        
        .notification.success { background: #059669; }
        .notification.error { background: #dc2626; }
        .notification.show { opacity: 1; }
        
        .feeding-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #059669;
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin-bottom: 16px; 
        }
        
        .stats-card { 
            background: white; 
            padding: 16px 12px; 
            border-radius: 10px; 
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }
        
        .stats-number { 
            font-size: 22px; 
            font-weight: 800; 
            margin-bottom: 4px;
        }
        
        .stats-label { 
            font-size: 11px; 
            color: #64748b; 
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .text-blue { color: #2563eb; }
        .text-green { color: #059669; }
        .text-red { color: #dc2626; }
        .text-purple { color: #7c3aed; }
        
        @media (max-width: 640px) {
            .animal-details { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1 class="title">OS Pecura</h1>
                    <p class="subtitle">Système de gestion de cheptel professionnel</p>
                </div>
                <div class="stat-badge">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Animaux</div>
                </div>
            </div>
            
            <nav class="nav">
                <button class="nav-btn active" onclick="showView('inventory')">🐑 Animaux</button>
                <button class="nav-btn" onclick="showView('feeding')">🌾 Nutrition</button>
                <button class="nav-btn" onclick="showView('stats')">📈 Stats</button>
            </nav>
        </div>
        
        <div class="content">
            <!-- Vue Inventaire -->
            <div id="view-inventory">
                <div class="card">
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="openAddModal()">✚ Ajouter Animal</button>
                        <button class="btn btn-success" onclick="importSampleData()">⬇ Import Exemples</button>
                        <button class="btn btn-warning" onclick="exportData()">⬆ Export CSV</button>
                        <button class="btn btn-danger" onclick="clearAllData()">🗑️ Tout vider</button>
                    </div>
                </div>
                
                <div id="animals-container"></div>
                
                <div id="empty-inventory" class="empty-state">
                    <div class="empty-icon">🐄</div>
                    <h3 class="empty-title">Aucun animal enregistré</h3>
                    <p class="empty-text">Cliquez sur "Ajouter Animal" pour commencer</p>
                    <button class="btn btn-primary" onclick="openAddModal()">✚ Premier Animal</button>
                </div>
            </div>
            
            <!-- Vue Nutrition -->
            <div id="view-feeding" class="hidden">
                <div class="card">
                    <h2 style="color: #059669; margin-bottom: 8px; font-size: 18px; font-weight: 700;">🌾 Suivi Nutrition</h2>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="openFeedingModal()">✚ Nouvelle Ration</button>
                        <button class="btn btn-success" onclick="importSampleFeeding()">⬇ Import Exemples</button>
                        <button class="btn btn-warning" onclick="exportFeeding()">⬆ Export Nutrition</button>
                    </div>
                </div>
                
                <div id="feeding-container"></div>
                
                <div id="empty-feeding" class="empty-state">
                    <div class="empty-icon">🌾</div>
                    <h3 class="empty-title">Aucune donnée nutrition</h3>
                    <p class="empty-text">Ajoutez des enregistrements d'alimentation</p>
                </div>
            </div>
            
            <!-- Vue Stats -->
            <div id="view-stats" class="hidden">
                <div class="card">
                    <h2 style="color: #2563eb; margin-bottom: 8px; font-size: 18px; font-weight: 700;">📈 Statistiques</h2>
                </div>
                
                <div class="stats-grid">
                    <div class="stats-card">
                        <div class="stats-number text-blue" id="stat-total">0</div>
                        <div class="stats-label">Total</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number text-green" id="stat-present">0</div>
                        <div class="stats-label">Présents</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number text-red" id="stat-exited">0</div>
                        <div class="stats-label">Sortis</div>
                    </div>
                </div>
            </div>
        </div>
        
        <button class="fab" onclick="openAddModal()">✚</button>
    </div>

    <!-- Modal Ajouter Animal -->
    <div id="addModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ajouter un animal</h2>
                <button class="close-btn" onclick="closeAddModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ID animal *</label>
                    <input type="text" class="form-input" placeholder="Ex: 001, A123..." id="inputId">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Date d'entrée</label>
                    <input type="date" class="form-input" id="inputDate">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Date de naissance</label>
                    <input type="date" class="form-input" id="inputBirthDate">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nom éleveur</label>
                    <input type="text" class="form-input" placeholder="Ex: Jacques SANTINI" id="inputBreeder">
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Sexe</label>
                        <select class="form-select" id="inputSex">
                            <option value="">Choisir</option>
                            <option value="Mâle">Mâle</option>
                            <option value="Femelle">Femelle</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Lot *</label>
                        <select class="form-select" id="inputLot">
                            <option value="">Choisir</option>
                            <option value="Béliers moins 1 an">Béliers moins 1 an</option>
                            <option value="Béliers plus 1 an">Béliers plus 1 an</option>
                            <option value="Agnelles de pensions">Agnelles de pensions</option>
                            <option value="Béliers adultes de pension">Béliers adultes de pension</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emplacement *</label>
                    <select class="form-select" id="inputLocation">
                        <option value="">Choisir</option>
                        <option value="Bergerie 1">Bergerie 1</option>
                        <option value="Bergerie 2">Bergerie 2</option>
                        <option value="Tunnel 1">Tunnel 1</option>
                        <option value="Tunnel 2">Tunnel 2</option>
                        <option value="Dactyle 1">Dactyle 1</option>
                        <option value="Dactyle 2">Dactyle 2</option>
                        <option value="Infirmerie">Infirmerie</option>
                        <option value="Quarantaine">Quarantaine</option>
                        <option value="Parc extérieur">Parc extérieur</option>
                    </select>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="addAnimal()">💾 Sauvegarder</button>
                    <button class="btn btn-secondary" onclick="closeAddModal()">❌ Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nutrition -->
    <div id="feedingModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Saisie nutrition</h2>
                <button class="close-btn" onclick="closeFeedingModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Date *</label>
                    <input type="date" class="form-input" id="feedingDate">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emplacement *</label>
                    <select class="form-select" id="feedingLocation">
                        <option value="">Choisir</option>
                        <option value="Bergerie 1">Bergerie 1</option>
                        <option value="Bergerie 2">Bergerie 2</option>
                        <option value="Tunnel 1">Tunnel 1</option>
                        <option value="Tunnel 2">Tunnel 2</option>
                        <option value="Dactyle 1">Dactyle 1</option>
                        <option value="Dactyle 2">Dactyle 2</option>
                        <option value="Infirmerie">Infirmerie</option>
                        <option value="Quarantaine">Quarantaine</option>
                        <option value="Parc extérieur">Parc extérieur</option>
                        <option value="Ensemble">Ensemble emplacements</option>
                    </select>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Foin (bottes)</label>
                        <input type="number" class="form-input" min="0" value="0" id="feedingHay">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Aliment (kg)</label>
                        <input type="number" class="form-input" min="0" value="0" id="feedingFeed">
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="addFeeding()">💾 Sauvegarder</button>
                    <button class="btn btn-secondary" onclick="closeFeedingModal()">❌ Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales SIMPLES
        let animals = [];
        let feedingRecords = [];
        let currentView = 'inventory';

        // Données d'exemple
        const sampleAnimals = [
            {id: '001', entryDate: '2024-06-20', birthDate: '2024-03-15', sex: 'Mâle', lot: 'Béliers moins 1 an', breeder: 'Jacques SANTINI', location: 'Bergerie 1'},
            {id: '002', entryDate: '2024-06-21', birthDate: '2024-02-28', sex: 'Femelle', lot: 'Agnelles de pensions', breeder: 'Marie ROSSI', location: 'Bergerie 2'},
            {id: '003', entryDate: '2024-06-22', birthDate: '2023-04-10', sex: 'Mâle', lot: 'Béliers plus 1 an', breeder: 'Pierre MARTIN', location: 'Tunnel 1'},
            {id: '004', entryDate: '2024-06-18', birthDate: '2024-01-15', sex: 'Femelle', lot: 'Agnelles de pensions', breeder: 'Paul LECLERC', location: 'Dactyle 1'},
            {id: '005', entryDate: '2024-06-19', birthDate: '2023-12-20', sex: 'Mâle', lot: 'Béliers adultes de pension', breeder: 'Marc DUBOIS', location: 'Dactyle 2'},
            {id: '006', entryDate: '2024-06-23', birthDate: '2024-04-05', sex: 'Femelle', lot: 'Agnelles de pensions', breeder: 'Sophie BERNARD', location: 'Infirmerie'}
        ];

        const sampleFeeding = [
            {id: 1, date: '2024-06-20', location: 'Bergerie 1', hay: 2, feed: 150},
            {id: 2, date: '2024-06-21', location: 'Bergerie 2', hay: 1, feed: 100},
            {id: 3, date: '2024-06-22', location: 'Tunnel 1', hay: 1, feed: 80},
            {id: 4, date: '2024-06-22', location: 'Dactyle 1', hay: 1, feed: 75},
            {id: 5, date: '2024-06-23', location: 'Infirmerie', hay: 0, feed: 20},
            {id: 6, date: '2024-06-23', location: 'Ensemble', hay: 5, feed: 400}
        ];

        // SAUVEGARDE SIMPLE
        function saveData() {
            try {
                console.log('💾 OS Pecura - Sauvegarde des données...');
                localStorage.setItem('ospecura_animals', JSON.stringify(animals));
                localStorage.setItem('ospecura_feeding', JSON.stringify(feedingRecords));
                console.log('✅ Sauvegarde réussie!', {animaux: animals.length, nutrition: feedingRecords.length});
                return true;
            } catch (error) {
                console.error('❌ Erreur sauvegarde:', error);
                showNotification('Erreur de sauvegarde!', 'error');
                return false;
            }
        }

        // EXPORT NUTRITION CSV
        function exportFeeding() {
            console.log('📤 Export Nutrition CSV...');
            try {
                if (feedingRecords.length === 0) {
                    showNotification('❌ Aucune donnée nutrition à exporter!', 'error');
                    return;
                }

                // En-têtes avec espaces et caractères français
                const headers = [
                    'Date Distribution',
                    'Emplacement', 
                    'Foin (bottes)',
                    'Aliment (kg)',
                    'Date Création'
                ];
                
                // Créer le CSV avec séparateur point-virgule
                let csv = headers.join(';') + '\n';
                
                // Trier par date décroissante
                const sortedRecords = feedingRecords.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedRecords.forEach(record => {
                    const row = [
                        record.date || '',
                        `"${record.location || ''}"`,
                        record.hay || '0',
                        record.feed || '0',
                        record.createdAt ? new Date(record.createdAt).toLocaleDateString('fr-FR') : ''
                    ];
                    csv += row.join(';') + '\n';
                });

                // Ajouter BOM pour Excel français
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csv;

                const blob = new Blob([csvWithBOM], { 
                    type: 'text/csv;charset=utf-8;' 
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `OS_Pecura_Nutrition_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('✅ Export nutrition réussi!', 'success');
            } catch (error) {
                console.error('❌ Erreur export nutrition:', error);
                showNotification('❌ Erreur export nutrition', 'error');
            }
        }

        // CHARGEMENT SIMPLE
        function loadData() {
            try {
                console.log('📂 OS Pecura - Chargement des données...');
                const savedAnimals = localStorage.getItem('ospecura_animals');
                const savedFeeding = localStorage.getItem('ospecura_feeding');
                
                if (savedAnimals) {
                    animals = JSON.parse(savedAnimals);
                    console.log('✅ Animaux chargés:', animals.length);
                }
                
                if (savedFeeding) {
                    feedingRecords = JSON.parse(savedFeeding);
                    console.log('✅ Nutrition chargée:', feedingRecords.length);
                }
                
                return true;
            } catch (error) {
                console.error('❌ Erreur chargement:', error);
                animals = [];
                feedingRecords = [];
                return false;
            }
        }

        // INITIALISATION
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Démarrage OS Pecura...');
            loadData();
            setTodayDate();
            updateDisplay();
            showNotification('OS Pecura prêt!', 'success');
        });

        // DATE DU JOUR
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (!input.value) input.value = today;
            });
        }

        // NAVIGATION
        function showView(viewName) {
            console.log('📍 Navigation vers:', viewName);
            currentView = viewName;
            
            // Mettre à jour les boutons
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[
                viewName === 'inventory' ? 0 : viewName === 'feeding' ? 1 : 2
            ].classList.add('active');
            
            // Masquer toutes les vues
            document.querySelectorAll('[id^="view-"]').forEach(view => view.classList.add('hidden'));
            
            // Afficher la vue demandée
            const targetView = document.getElementById(`view-${viewName}`);
            if (targetView) {
                targetView.classList.remove('hidden');
            }
            
            updateDisplay();
        }

        // AJOUTER UN ANIMAL - VERSION ULTRA SIMPLE
        function addAnimal() {
            console.log('🐑 Tentative d\'ajout d\'animal...');
            
            try {
                // Récupérer les valeurs
                const id = document.getElementById('inputId').value.trim();
                const date = document.getElementById('inputDate').value;
                const birthDate = document.getElementById('inputBirthDate').value;
                const breeder = document.getElementById('inputBreeder').value.trim();
                const sex = document.getElementById('inputSex').value;
                const lot = document.getElementById('inputLot').value;
                const location = document.getElementById('inputLocation').value;

                console.log('📝 Données saisies:', {id, date, birthDate, breeder, sex, lot, location});

                // Validation SIMPLE
                if (!id) {
                    showNotification('❌ ID obligatoire!', 'error');
                    return;
                }
                
                if (!lot) {
                    showNotification('❌ Lot obligatoire!', 'error');
                    return;
                }
                
                if (!location) {
                    showNotification('❌ Emplacement obligatoire!', 'error');
                    return;
                }

                // Vérifier les doublons
                if (animals.find(a => a.id === id)) {
                    showNotification('❌ ID déjà utilisé!', 'error');
                    return;
                }

                // Créer l'animal
                const newAnimal = {
                    id: id,
                    entryDate: date || new Date().toISOString().split('T')[0],
                    birthDate: birthDate || '',
                    breeder: breeder || '',
                    sex: sex || '',
                    lot: lot,
                    location: location,
                    createdAt: new Date().toISOString()
                };

                console.log('🆕 Nouvel animal:', newAnimal);

                // AJOUTER à la liste
                animals.push(newAnimal);
                console.log('📊 Total animaux après ajout:', animals.length);

                // SAUVEGARDER
                if (saveData()) {
                    console.log('✅ Animal ajouté et sauvegardé!');
                    closeAddModal();
                    updateDisplay();
                    showNotification(`✅ Animal ${id} ajouté!`, 'success');
                } else {
                    console.log('❌ Erreur lors de la sauvegarde');
                    // Annuler l'ajout en cas d'erreur de sauvegarde
                    animals.pop();
                }

            } catch (error) {
                console.error('❌ Erreur lors de l\'ajout:', error);
                showNotification('❌ Erreur: ' + error.message, 'error');
            }
        }

        // AJOUTER NUTRITION
        function addFeeding() {
            console.log('🌾 Tentative d\'ajout nutrition...');
            
            try {
                const date = document.getElementById('feedingDate').value;
                const location = document.getElementById('feedingLocation').value;
                const hay = parseInt(document.getElementById('feedingHay').value) || 0;
                const feed = parseInt(document.getElementById('feedingFeed').value) || 0;

                console.log('📝 Données nutrition:', {date, location, hay, feed});

                if (!date || !location) {
                    showNotification('❌ Date et emplacement obligatoires!', 'error');
                    return;
                }

                const newFeeding = {
                    id: Date.now(),
                    date: date,
                    location: location,
                    hay: hay,
                    feed: feed,
                    createdAt: new Date().toISOString()
                };

                feedingRecords.push(newFeeding);
                console.log('📊 Total nutrition après ajout:', feedingRecords.length);

                if (saveData()) {
                    closeFeedingModal();
                    updateDisplay();
                    showNotification('✅ Nutrition ajoutée!', 'success');
                }

            } catch (error) {
                console.error('❌ Erreur nutrition:', error);
                showNotification('❌ Erreur: ' + error.message, 'error');
            }
        }

        // MODALS
        function openAddModal() {
            console.log('🔓 Ouverture modal ajout');
            document.getElementById('addModal').classList.remove('hidden');
            setTodayDate();
            clearForm();
        }

        function closeAddModal() {
            console.log('🔒 Fermeture modal ajout');
            document.getElementById('addModal').classList.add('hidden');
        }

        function openFeedingModal() {
            console.log('🔓 Ouverture modal nutrition');
            document.getElementById('feedingModal').classList.remove('hidden');
            setTodayDate();
        }

        function closeFeedingModal() {
            console.log('🔒 Fermeture modal nutrition');
            document.getElementById('feedingModal').classList.add('hidden');
        }

        function clearForm() {
            document.getElementById('inputId').value = '';
            document.getElementById('inputBreeder').value = '';
            document.getElementById('inputSex').value = '';
            document.getElementById('inputLot').value = '';
            document.getElementById('inputLocation').value = '';
            document.getElementById('inputBirthDate').value = '';
        }

        // IMPORT DONNÉES EXEMPLES
        function importSampleData() {
            console.log('📥 Import des données exemples...');
            try {
                sampleAnimals.forEach(sample => {
                    if (!animals.find(a => a.id === sample.id)) {
                        animals.push({...sample, createdAt: new Date().toISOString()});
                    }
                });
                
                if (saveData()) {
                    updateDisplay();
                    showNotification(`✅ ${sampleAnimals.length} animaux importés!`, 'success');
                }
            } catch (error) {
                console.error('❌ Erreur import:', error);
                showNotification('❌ Erreur import', 'error');
            }
        }

        function importSampleFeeding() {
            console.log('📥 Import nutrition exemples...');
            try {
                sampleFeeding.forEach(sample => {
                    if (!feedingRecords.find(f => f.id === sample.id)) {
                        feedingRecords.push({...sample, createdAt: new Date().toISOString()});
                    }
                });
                
                if (saveData()) {
                    updateDisplay();
                    showNotification(`✅ ${sampleFeeding.length} records nutrition importés!`, 'success');
                }
            } catch (error) {
                console.error('❌ Erreur import nutrition:', error);
                showNotification('❌ Erreur import nutrition', 'error');
            }
        }

        // EXPORT CSV
        function exportData() {
            console.log('📤 Export CSV...');
            try {
                if (animals.length === 0) {
                    showNotification('❌ Aucune donnée à exporter!', 'error');
                    return;
                }

                // En-têtes avec espaces et caractères français
                const headers = [
                    'ID Animal',
                    'Date Entrée', 
                    'Date Naissance',
                    'Sexe',
                    'Lot',
                    'Nom Éleveur',
                    'Emplacement',
                    'Statut'
                ];
                
                // Créer le CSV avec séparateur point-virgule pour Excel français
                let csv = headers.join(';') + '\n';
                
                animals.forEach(animal => {
                    const row = [
                        animal.id || '',
                        animal.entryDate || '',
                        animal.birthDate || '',
                        animal.sex || '',
                        `"${animal.lot || ''}"`,  // Guillemets pour les espaces
                        `"${animal.breeder || ''}"`,  // Guillemets pour les noms
                        `"${animal.location || ''}"`,  // Guillemets pour les espaces
                        animal.exitDate ? 'Sorti' : 'Présent'
                    ];
                    csv += row.join(';') + '\n';
                });

                // Ajouter BOM pour caractères français dans Excel
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csv;

                const blob = new Blob([csvWithBOM], { 
                    type: 'text/csv;charset=utf-8;' 
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `OS_Pecura_Export_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('✅ Export réussi! Fichier téléchargé', 'success');
            } catch (error) {
                console.error('❌ Erreur export:', error);
                showNotification('❌ Erreur export', 'error');
            }
        }

        // VIDER TOUTES LES DONNÉES
        function clearAllData() {
            if (confirm('⚠️ Voulez-vous vraiment supprimer TOUTES les données ?')) {
                animals = [];
                feedingRecords = [];
                saveData();
                updateDisplay();
                showNotification('🗑️ Toutes les données supprimées!', 'success');
            }
        }

        // MISE À JOUR AFFICHAGE
        function updateDisplay() {
            console.log('🔄 Mise à jour affichage');
            
            try {
                // Mettre à jour le compteur
                document.getElementById('totalCount').textContent = animals.length;

                if (currentView === 'inventory') {
                    updateInventoryView();
                } else if (currentView === 'feeding') {
                    updateFeedingView();
                } else if (currentView === 'stats') {
                    updateStatsView();
                }
            } catch (error) {
                console.error('❌ Erreur affichage:', error);
            }
        }

        function updateInventoryView() {
            const container = document.getElementById('animals-container');
            const empty = document.getElementById('empty-inventory');
            
            if (animals.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                container.innerHTML = animals.map(animal => {
                    const sexBadge = animal.sex ? 
                        `<div class="sex-badge ${animal.sex === 'Mâle' ? 'sex-male' : 'sex-female'}">${animal.sex === 'Mâle' ? '♂' : '♀'}</div>` : '';
                    
                    return `<div class="animal-card">
                        <div class="animal-header">
                            <div>
                                <div class="animal-id">${animal.id}</div>
                                <div class="animal-lot">${animal.lot || ''}</div>
                            </div>
                            <div style="display: flex; gap: 6px; align-items: center;">
                                ${sexBadge}
                                <button onclick="deleteAnimal('${animal.id}')" class="btn btn-danger btn-small">🗑️</button>
                            </div>
                        </div>
                        <div class="animal-details">
                            <div>
                                <div class="detail-label">Emplacement</div>
                                <div class="detail-value">${animal.location || ''}</div>
                            </div>
                            <div>
                                <div class="detail-label">Entrée</div>
                                <div class="detail-value">${animal.entryDate || 'Non renseigné'}</div>
                            </div>
                            ${animal.birthDate ? `
                            <div>
                                <div class="detail-label">Naissance</div>
                                <div class="detail-value">${animal.birthDate}</div>
                            </div>` : ''}
                            ${animal.breeder ? `
                                <div style="grid-column: 1 / -1;">
                                    <div class="detail-label">Éleveur</div>
                                    <div class="detail-value">${animal.breeder}</div>
                                </div>` : ''}
                        </div>
                    </div>`;
                }).join('');
            }
        }

        function updateFeedingView() {
            const container = document.getElementById('feeding-container');
            const empty = document.getElementById('empty-feeding');
            
            if (feedingRecords.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                const sortedRecords = feedingRecords.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
                
                container.innerHTML = sortedRecords.map(record => {
                    return `<div class="feeding-card">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div>
                                <div style="font-size: 16px; font-weight: 700; color: #1e293b;">${record.location}</div>
                                <div style="color: #059669; font-weight: 600; font-size: 14px;">${record.date}</div>
                            </div>
                            <button onclick="deleteFeeding(${record.id})" class="btn btn-danger btn-small">🗑️</button>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            ${record.hay > 0 ? `
                                <div style="background: #f0fdf4; border: 1px solid #bbf7d0; padding: 8px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 10px; color: #166534; margin-bottom: 2px;">Foin</div>
                                    <div style="font-size: 13px; font-weight: 700; color: #059669;">${record.hay} bottes</div>
                                </div>` : ''}
                            ${record.feed > 0 ? `
                                <div style="background: #f0fdf4; border: 1px solid #bbf7d0; padding: 8px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 10px; color: #166534; margin-bottom: 2px;">Aliment</div>
                                    <div style="font-size: 13px; font-weight: 700; color: #059669;">${record.feed} kg</div>
                                </div>` : ''}
                        </div>
                    </div>`;
                }).join('');
            }
        }

        function updateStatsView() {
            const total = animals.length;
            const males = animals.filter(a => a.sex === 'Mâle').length;
            const females = animals.filter(a => a.sex === 'Femelle').length;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-present').textContent = total; // Version simplifiée
            document.getElementById('stat-exited').textContent = '0'; // Version simplifiée
        }

        // SUPPRIMER UN ANIMAL
        function deleteAnimal(animalId) {
            console.log('🗑️ Suppression animal:', animalId);
            if (confirm(`Supprimer l'animal ${animalId} ?`)) {
                const index = animals.findIndex(a => a.id === animalId);
                if (index !== -1) {
                    animals.splice(index, 1);
                    saveData();
                    updateDisplay();
                    showNotification(`🗑️ Animal ${animalId} supprimé!`, 'success');
                }
            }
        }

        // SUPPRIMER NUTRITION
        function deleteFeeding(feedingId) {
            console.log('🗑️ Suppression nutrition:', feedingId);
            if (confirm('Supprimer cet enregistrement nutrition ?')) {
                const index = feedingRecords.findIndex(f => f.id === feedingId);
                if (index !== -1) {
                    feedingRecords.splice(index, 1);
                    saveData();
                    updateDisplay();
                    showNotification('🗑️ Nutrition supprimée!', 'success');
                }
            }
        }

        // NOTIFICATIONS
        function showNotification(message, type = 'success') {
            console.log('📢 Notification:', message);
            
            try {
                // Supprimer notification existante
                const existing = document.querySelector('.notification');
                if (existing) existing.remove();

                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => notification.classList.add('show'), 100);

                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            } catch (error) {
                console.error('❌ Erreur notification:', error);
            }
        }

        // GESTION DES CLICS
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                closeAddModal();
                closeFeedingModal();
            }
        });

        // GESTION DES TOUCHES
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAddModal();
                closeFeedingModal();
            }
        });

        // SAUVEGARDE AVANT FERMETURE
        window.addEventListener('beforeunload', function() {
            saveData();
        });

        // TEST RAPIDE (pour debug)
        function testAdd() {
            console.log('🧪 Test rapide...');
            document.getElementById('inputId').value = 'TEST' + Date.now();
            document.getElementById('inputBirthDate').value = '2024-03-01';
            document.getElementById('inputLot').value = 'Béliers moins 1 an';
            document.getElementById('inputLocation').value = 'Bergerie 1';
            document.getElementById('inputSex').value = 'Mâle';
            document.getElementById('inputBreeder').value = 'Test Éleveur';
        }

        // Console commands pour debug
        window.osPecura = {
            animals: () => animals,
            feeding: () => feedingRecords,
            save: saveData,
            load: loadData,
            clear: clearAllData,
            test: testAdd,
            version: '2.0'
        };

        console.log('🔧 Debug OS Pecura disponible via: window.osPecura');
    </script>
</body>
</html>
